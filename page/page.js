"use strict";(()=>{var U=`\u0415\u0441\u043B\u0438 \u0432\u044B \u0445\u043E\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0430\u0442\u044C \u043F\u0440\u043E\u0435\u043A\u0442, \u043F\u043E\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u2605 \u043D\u0430 
<a href="https://github.com/OneTwoZzzPlus/reviews-extension">\u0440\u0435\u043F\u043E\u0437\u0438\u0442\u043E\u0440\u0438\u0439</a>. <br/>
\u041E\u0442\u0437\u044B\u0432\u044B \u0430\u0433\u0440\u0435\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0438\u0437 \u043E\u0442\u043A\u0440\u044B\u0442\u044B\u0445 \u0438\u0441\u0442\u043E\u0447\u043D\u0438\u043A\u043E\u0432.`,_="\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C...",k="<br/>(\u043E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u0435/\u0441\u0430\u0439\u0442)",D="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0445\u043E\u0442\u044F \u0431\u044B 3 \u0441\u0438\u043C\u0432\u043E\u043B\u0430 =]",J='<span class="error">\u041D\u0435 \u043F\u043E\u043D\u044F\u0442\u043D\u043E, \u0447\u0442\u043E \u044D\u0442\u043E \u0442\u0430\u043A\u043E\u0435 :|</span>'+k,b="\u041E\u0442\u0437\u044B\u0432\u044B \u043F\u0440\u0438\u0448\u043B\u0438 \u0441\u043B\u043E\u043C\u0430\u043D\u043D\u044B\u0435 =("+k,q="\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u0440\u0438\u0448\u043B\u0438 \u0441\u043B\u043E\u043C\u0430\u043D\u043D\u044B\u0435 =("+k;function y(e){switch(e){case 0:return'<span class="error">\u0421\u0435\u0440\u0432\u0435\u0440 \u0441 \u043E\u0442\u0437\u044B\u0432\u0430\u043C\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D =(</span>';case 401:return"\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043E\u0439\u0434\u0438\u0442\u0435, \u044D\u0442\u043E \u0431\u044B\u0441\u0442\u0440\u043E =)";case 404:return"\u041E\u0442\u0437\u044B\u0432\u044B \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044E\u0442 \\(O_o)/";default:return`\u0421\u0435\u0440\u0432\u0435\u0440 \u043F\u0440\u0438\u0441\u043B\u0430\u043B "${e}" \u0432\u043C\u0435\u0441\u0442\u043E \u043E\u0442\u0437\u044B\u0432\u043E\u0432 =(`}}function z(e){switch(e){case 0:return'<span class="error">\u0421\u0435\u0440\u0432\u0435\u0440 \u0441 \u043E\u0442\u0437\u044B\u0432\u0430\u043C\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D =(</span>';case 401:return"\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043E\u0439\u0434\u0438\u0442\u0435, \u044D\u0442\u043E \u0431\u044B\u0441\u0442\u0440\u043E =)";case 404:return"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E \\(O_o)/";default:return`\u0421\u0435\u0440\u0432\u0435\u0440 \u043F\u0440\u0438\u0441\u043B\u0430\u043B "${e}" \u0432\u043C\u0435\u0441\u0442\u043E \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u043E\u0432 \u043F\u043E\u0438\u0441\u043A\u0430 =(`}}function G(e,t){return t?`${t} (${e})`:`${e}`}var F={teacher:"\u{1F48E}",subject:"\u{1F4DA}"},K=`\u042D\u0442\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F \u043F\u043E <b>ID.ITMO</b> \u0447\u0435\u0440\u0435\u0437 \u043F\u0440\u043E\u043A\u0441\u0438. <br/>
\u0415\u0441\u043B\u0438 \u0434\u043E\u0432\u0435\u0440\u044F\u0435\u0442\u0435 \u0441\u0430\u0439\u0442\u0443, \u0432\u0432\u043E\u0434\u0438\u0442\u0435 \u043B\u043E\u0433\u0438\u043D \u0438 \u043F\u0430\u0440\u043E\u043B\u044C. <br/> 
\u041E\u0434\u043D\u0430\u043A\u043E \u0432\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C <a href="https://github.com/OneTwoZzzPlus/reviews-extension/releases">\u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u0435</a>: \u043E\u043D\u043E \u0441\u0430\u043C\u043E \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0438\u0442, \u043A\u0442\u043E \u0432\u044B!`,V="\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0435 \u043B\u043E\u0433\u0438\u043D \u0438\u043B\u0438 \u043F\u0430\u0440\u043E\u043B\u044C!",W="\u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u043B\u043E\u0433\u0438\u043D \u0438 \u043F\u0430\u0440\u043E\u043B\u044C! \u041F\u0440\u043E\u0446\u0435\u0441\u0441 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438 \u0431\u044B\u043B \u043D\u0430\u0440\u0443\u0448\u0435\u043D",C="\u0412\u0445\u043E\u0434",Z="\u0412\u0445\u043E\u0434 \u231B";function x(e){try{let t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=atob(t),r=Uint8Array.from(n,s=>s.charCodeAt(0)),o=new TextDecoder("utf-8").decode(r);return JSON.parse(o)}catch(t){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 JWT",t),null}}function $(e){if(!e)return-1/0;let t=e.match(/(\d{2}):(\d{2})\s+(\d{2})\.(\d{2})\.(\d{4})/);if(!t)return-1/0;let[,n,r,o,s,a]=t;return new Date(Number(a),Number(s)-1,Number(o),Number(n),Number(r)).getTime()}function M(e,t,n={}){let{days:r=1,path:o="/",sameSite:s="Lax",secure:a=!1}=n,c=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;r&&(c+=`; max-age=${r*86400}`),c+=`; path=${o}`,c+=`; SameSite=${s}`,a&&(c+="; Secure"),document.cookie=c}function A(e){let t=document.cookie.split("; ").find(n=>n.startsWith(encodeURIComponent(e)+"="));return t?decodeURIComponent(t.split("=")[1]):null}var f=!1,h=null,d=null,v=0,he=300;function Q(e,t){h=e,d=t;let n=x(d);n?.exp&&(v=n.exp||0)}function X(){return Date.now()>=v*1e3-he*1e3}function L(e){return x(e)?.isu?!0:(console.error("[AUTHP] isu not found"),!1)}function Te(e,t){f=!0,chrome.runtime?.id&&chrome.storage.local.set({refresh_token:e,access_token:t},()=>{let n=chrome.runtime.lastError;n&&!n.message.includes("Extension context invalidated")?console.error(n):(Q(e,t),console.log("[AUTHP] tokens saved successfully"))})}function ge(){f=!0,chrome.storage.local.remove(["refresh_token","access_token"]),h=null,d=null,v=0}function H(e,t){f=!1,M("refresh_token",e,{secure:!0}),M("access_token",t,{secure:!0})}function Y(){return f=!1,new Promise((e,t)=>{let n=A("refresh_token"),r=A("access_token");if(n&&r){Q(n,r);let o=x(r);o?e(o):t()}else t()})}function xe(){f=!1,document.cookie="refresh_token=; Max-Age=-1;",document.cookie="access_token=; Max-Age=-1;",h=null,d=null,v=0}function ee(e,t){f?Te(e,t):H(e,t)}function te(){f?ge():xe()}async function T(e,t,n={},r=null){let o=new URL(t,"https://reviews.work.gd/"),s={method:e.toUpperCase(),headers:{"Content-Type":"application/json"},signal:r?.signal};if(h)try{if(!d||X()){let a=new URL("/authp/refresh","https://reviews.work.gd/"),c=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:h})});if(c.ok){let p=(await c.json())?.access_token;p&&L(p)&&ee(h,p)}else console.error("[API] Refresh status code "+c.status),te()}d&&(s.headers.token=d)}catch(a){console.error("[API] Unable to refresh the token",a)}return s.method==="GET"?Object.entries(n).forEach(([a,c])=>{o.searchParams.set(a,c.toString())}):s.body=JSON.stringify(n),new Promise((a,c)=>{fetch(o,s).then(async l=>{if(l.ok){console.log("[API] fetch resolved");let p=await l.text();a(p?JSON.parse(p):{})}else{let p=await l.json().catch(()=>({}));l.status===401||l.status===404?console.info("[API] error details:",p):console.error("[API] error details:",p),c(l.status)}}).catch(l=>{l.name!=="AbortError"?(console.error("[API] network error:",l),c(0)):console.log("[API] fetch aborted")})})}async function ne(e,t){return console.log(`[API] send /search for "${e}"`),await T("GET","/search",{query:e},t)}async function re(e){return console.log(`[API] send /teacher for "${e}"`),await T("GET",`/teacher/${e}`,{})}async function oe(e){return console.log(`[API] send /subject for "${e}"`),await T("GET",`/subject/${e}`,{})}async function se(e,t){return console.log(`[API] send /teacher/${e}/rate ${t}`),await T("POST",`/teacher/${e}/rate`,{user_rating:t})}async function S(e,t){return console.log(`[API] send /comment/${e}/vote ${t}`),await T("POST",`/comment/${e}/vote`,{user_karma:t})}async function ae(e,t){return console.log("[API] send /authp/login"),await T("POST","/authp/login",{username:e,password:t})}function N(e){let t=document.createElement("div");t.classList.add("comments-wrap");let n=ie(e);if(e.length>1){let r=we(e);r.addEventListener("change",o=>{let s=parseInt(o.target.value);console.log(`[UI] sorting model ${s}`);let a=ie(e,s);t.replaceChild(a,n),n=a}),t.appendChild(r)}return t.appendChild(n),t}function ie(e,t=0){let n=document.createElement("div");return n.classList.add("comments"),ke(e,t).map(o=>n.append(ve(o))),n}function ve(e){let t=document.createElement("div");return t.classList.add("comment"),t.innerHTML=`
        <div class="comment-head">
            \u041E\u0442\u0437\u044B\u0432 ${e.date}
            ${e?.subject?` \u043F\u043E \u043F\u0440\u0435\u0434\u043C\u0435\u0442\u0443 "${e.subject.title}"`:" "}
            ${e?.source?` \u0438\u0441\u0442\u043E\u0447\u043D\u0438\u043A "<a href="${e.source.link??""}">${e.source.title}</a>"`:""}
        </div>
        <div>${e.text}</div>
    `,t.appendChild(Le(e.id,e.karma,e.user_karma)),t}function Le(e,t,n){let r=document.createElement("div");r.classList.add("karma");let o=document.createElement("span");o.classList.add("karma-value");let s=document.createElement("button");s.classList.add("karma-btn");let a=document.createElement("button");return a.classList.add("karma-btn"),s.addEventListener("click",async c=>{let l=await S(e,n===1?0:1);n=l.user_karma,t=l.karma,P(o,s,a,t,n)}),a.addEventListener("click",async c=>{let l=await S(e,n===-1?0:-1);n=l.user_karma,t=l.karma,P(o,s,a,t,n)}),P(o,s,a,t,n),r.appendChild(s),r.appendChild(o),r.appendChild(a),r}function P(e,t,n,r,o){o==null&&(o=0),e.innerHTML=r,t.innerHTML=o===1?"\u25B2":"\u25B3",n.innerHTML=o===-1?"\u25BC":"\u25BD"}function we(){let e=document.createElement("select");return e.name="sort",e.classList.add("comments-dropdown"),e.innerHTML=`
        <option value="0">C \u0432\u044B\u0441\u043E\u043A\u043E\u0439 \u043A\u0430\u0440\u043C\u044B</option>
        <option value="1">\u0421 \u043D\u0438\u0437\u043A\u043E\u0439 \u043A\u0430\u0440\u043C\u044B</option>
        <option value="2">\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043D\u043E\u0432\u044B\u0435</option>
        <option value="3">\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u0442\u0430\u0440\u044B\u0435</option>`,e}function ke(e,t=0){return[...e].sort((n,r)=>{let o=$(n.date),s=$(r.date),a;switch(t){case 0:return a=r.karma-n.karma,a===0?Number.isNaN(o)||Number.isNaN(s)?0:s-o:a;case 1:return a=n.karma-r.karma,a===0?Number.isNaN(o)||Number.isNaN(s)?0:s-o:a;case 2:return Number.isNaN(o)||Number.isNaN(s)?0:s-o;case 3:return Number.isNaN(o)||Number.isNaN(s)?0:o-s;default:return 0}})}function I(e,t,n){let r=document.createElement("div");return r.classList.add("rating-box"),r.innerHTML=ce(e,t,n),r.addEventListener("change",async o=>{if(o.target.name===`rating-${e}`){let s=parseInt(o.target.value),a=await se(e,s);r.innerHTML=ce(e,a.rating,a.user_rating)}}),r}function ce(e,t,n){n==null&&(n=0);let r=[5,4,3,2,1].map(o=>`
        <input type="radio" id="rate-${e}-${o}" name="rating-${e}" value="${o}" ${n===o?"checked":""}>
        <label for="rate-${e}-${o}">\u2605</label>
    `).join("");return`
        <div class="rating-row">
            <span class="rating-title">\u0421\u0440\u0435\u0434\u043D\u044F\u044F \u043E\u0446\u0435\u043D\u043A\u0430:</span>
            <span class="rating-value">${t}</span>
        </div>
        <div class="rating-row">
            <span class="rating-title">\u0412\u0430\u0448\u0430 \u043E\u0446\u0435\u043D\u043A\u0430:</span>
            <div class="rating">${r}</div>
        </div>
    `}function R(e){let t=e.map(r=>`
        <div class="summary">
            <span class="summary-title">${r.title??""}</span>: 
            <span class="summary-value">${r.value??""}</span>
        </div>
    `).join(""),n=document.createElement("div");return n.classList.add("summaries"),n.innerHTML=t,n}function w(e){if(!e||!Array.isArray(e.summaries)||!Array.isArray(e.comments)||e.summaries.length===0&&e.comments.length===0)return null;let t=document.createElement("div");return t.classList.add("reviews-content-box"),t.appendChild(I(e.id,e.rating,e?.user_rating)),e.summaries.length!==0&&t.appendChild(R(e.summaries)),e.comments.length!==0&&t.appendChild(N(e.comments)),t}var m=document.createElement("p");m.classList.add("note");m.innerHTML=U;function le(e){let t=w(e);if(t===null)return null;let n=document.createElement("div");return n.innerHTML=`<h2>${e.name}</h2>`,n.appendChild(t),n}function ue(e){if(!e||!Array.isArray(e.teachers))return null;e.teachers.sort((r,o)=>{let s=o.rating-r.rating;return s===0?o.id-r.id:s});let t=e.teachers.map(r=>w(r));if(t.some(r=>r===null))return null;let n=document.createElement("div");return n.innerHTML=`<h2>${e.title}</h2>`,e.teachers.forEach((r,o)=>{let s=document.createElement("details");s.innerHTML=`<summary class="reviews-title">${r.name}</summary>`,s.appendChild(t[o]),n.appendChild(s)}),n}function pe(e,t){let n=document.createElement("div");return n.className="search-list",e.results.forEach(r=>{let o=document.createElement("div");o.className="search-item",o.innerHTML=`
            ${F[r.type]||""}
            ${r.title}
            <span class="search-id">${r.id}</span>
        `,o.addEventListener("click",async()=>t(r.id,r.type)),n.appendChild(o)}),n}var g,i,u,j,de,O;function me(){u=document.querySelector("#reviews-status-box"),g=document.querySelector("#reviews-isu-box"),i=document.querySelector("#reviews-container"),j=document.querySelector("#reviews-input"),j.addEventListener("input",()=>{clearTimeout(de),de=setTimeout(be,300)})}async function be(){let e=j.value.trim();if(e){if(e.length<3){u.innerHTML=D;return}}else{u.innerHTML="";return}u.innerHTML=_,O?.abort(),O=new AbortController,ne(e,O).then(t=>{let n=pe(t,ye);n?(u.innerHTML="",i.innerHTML="",i.appendChild(n),i.appendChild(m)):(i.innerHTML="",u.innerHTML=q)}).catch(t=>{i.innerHTML="",u.innerHTML=z(t)})}async function ye(e,t){switch(t){case"teacher":re(e).then(n=>{let r=le(n);r!==null?(i.innerHTML="",i.appendChild(r),i.appendChild(m)):u.innerHTML=b}).catch(n=>{u.innerHTML=y(n)});break;case"subject":oe(e).then(n=>{let r=ue(n);r!==null?(i.innerHTML="",i.appendChild(r),i.appendChild(m)):u.innerHTML=b}).catch(n=>{u.innerHTML=y(n)});break;default:console.error(`\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u044B\u0439 type ${t}`),u.innerHTML=J}}document.addEventListener("DOMContentLoaded",Ce);async function Ce(){me(),fe()}function B(e){i.innerHTML="",i.appendChild(Ee()),i.appendChild(m)}function fe(){Y().then(e=>{e?.isu&&(g.innerHTML=G(e?.isu,e?.name)),g.removeEventListener("click",B)}).catch(e=>{g.removeEventListener("click",B),g.addEventListener("click",B)})}function Ee(){let e=document.createElement("form");e.classList.add("login-form"),e.innerHTML=`
        <p>${K}</p>
    
        <input type="email" name="email" placeholder="E-mail" required />
        <input type="password" name="password" placeholder="\u041F\u0430\u0440\u043E\u043B\u044C" required />
    
        <button id="authp-login" type="submit">\u0412\u0445\u043E\u0434</button>
    `;let t=e.querySelector("#authp-login");return e.addEventListener("submit",async n=>{n.preventDefault(),t.disabled=!0,t.innerHTML=Z,ae(e.email.value,e.password.value).then(r=>{let o=r?.refresh_token,s=r?.access_token;if(!o||!s){console.error("[AUTHP] Invalid response",r),t.disabled=!1,t.innerHTML=C;return}L(s)&&(H(o,s),i.innerHTML="",fe())}).catch(r=>{alert(r===401?V:W+` (\u0441\u0442\u0430\u0442\u0443\u0441 ${r})`),t.disabled=!1,t.innerHTML=C})}),e}})();
//# sourceMappingURL=page.js.map
